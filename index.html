<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P File Transfer</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body { background-color: #0f172a; }
.drop-zone.dragover { border-color: #22d3ee; background-color: #1e293b; }
</style>
</head>
<body class="text-white min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-2xl space-y-6">

<h1 class="text-3xl font-bold text-center text-cyan-400">P2P File Transfer</h1>

<!-- Generate ID -->
<div class="space-y-2">
<button id="generateIdBtn"
class="w-full py-3 bg-cyan-500 hover:bg-cyan-400 rounded-xl text-lg font-semibold transition">
Generar ID de transferencia
</button>
<p id="myId" class="text-center text-sm text-gray-400 break-all"></p>
</div>

<!-- Connect -->
<div class="space-y-2">
<input id="peerIdInput" type="text"
placeholder="Pega aquí el ID del otro dispositivo"
class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none">
<button id="connectBtn"
class="w-full py-3 bg-emerald-500 hover:bg-emerald-400 rounded-xl font-semibold transition">
Conectar
</button>
</div>

<!-- Drag Drop -->
<div id="dropZone"
class="drop-zone border-2 border-dashed border-slate-600 rounded-2xl p-10 text-center transition cursor-pointer">
<p class="text-gray-400">Arrastra y suelta tu archivo aquí</p>
<input type="file" id="fileInput" class="hidden">
</div>

<!-- Progress -->
<div class="space-y-2 hidden" id="progressContainer">
<div class="w-full bg-slate-700 rounded-full h-4">
<div id="progressBar" class="bg-cyan-500 h-4 rounded-full" style="width: 0%"></div>
</div>
<p id="progressText" class="text-sm text-gray-400 text-center"></p>
</div>

<!-- Preview -->
<div id="previewContainer" class="hidden space-y-4 text-center">
<img id="imagePreview" class="max-h-64 mx-auto rounded-xl shadow-lg">
<button id="downloadBtn"
class="py-3 px-6 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold transition disabled:opacity-50"
disabled>
Descargar
</button>
</div>

<p id="status" class="text-center text-sm text-yellow-400"></p>

</div>

<script>
let peer;
let connection;
let selectedFile;
let receivedBuffers = [];
let receivedSize = 0;
let fileMeta;

const CHUNK_SIZE = 64 * 1024;

const generateIdBtn = document.getElementById('generateIdBtn');
const myIdText = document.getElementById('myId');
const peerIdInput = document.getElementById('peerIdInput');
const connectBtn = document.getElementById('connectBtn');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const progressContainer = document.getElementById('progressContainer');
const statusText = document.getElementById('status');
const previewContainer = document.getElementById('previewContainer');
const imagePreview = document.getElementById('imagePreview');
const downloadBtn = document.getElementById('downloadBtn');

generateIdBtn.onclick = () => {
peer = new Peer();

peer.on('open', id => {
myIdText.textContent = "Tu ID: " + id;
statusText.textContent = "Esperando conexión...";
});

peer.on('connection', conn => {
connection = conn;
setupConnection();
});

peer.on('error', err => {
statusText.textContent = "Error: " + err;
});
};

connectBtn.onclick = () => {
if (!peer) {
statusText.textContent = "Primero genera tu ID.";
return;
}
connection = peer.connect(peerIdInput.value.trim());
setupConnection();
};

function setupConnection() {
connection.on('open', () => {
statusText.textContent = "Conectado ✔";
});

connection.on('data', data => {
if (data.type === "meta") {
fileMeta = data;
receivedBuffers = [];
receivedSize = 0;
progressContainer.classList.remove("hidden");
}
else if (data.type === "chunk") {
receivedBuffers.push(data.data);
receivedSize += data.data.byteLength;
updateProgress(receivedSize, fileMeta.size);
if (receivedSize === fileMeta.size) {
finishReceive();
}
}
});

connection.on('close', () => {
statusText.textContent = "Conexión cerrada.";
});

connection.on('error', err => {
statusText.textContent = "Error conexión: " + err;
});
}

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', e => {
e.preventDefault();
dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', e => {
e.preventDefault();
dropZone.classList.remove('dragover');
selectedFile = e.dataTransfer.files[0];
sendFile();
});

fileInput.addEventListener('change', e => {
selectedFile = e.target.files[0];
sendFile();
});

function sendFile() {
if (!connection || !connection.open) {
statusText.textContent = "No hay conexión activa.";
return;
}
if (!selectedFile) return;

connection.send({
type: "meta",
name: selectedFile.name,
size: selectedFile.size,
mime: selectedFile.type
});

progressContainer.classList.remove("hidden");

let offset = 0;
const reader = new FileReader();

reader.onload = e => {
connection.send({ type: "chunk", data: e.target.result });
offset += e.target.result.byteLength;
updateProgress(offset, selectedFile.size);

if (offset < selectedFile.size) {
readSlice(offset);
}
};

function readSlice(o) {
const slice = selectedFile.slice(o, o + CHUNK_SIZE);
reader.readAsArrayBuffer(slice);
}

readSlice(0);
}

function updateProgress(sent, total) {
const percent = (sent / total) * 100;
progressBar.style.width = percent + "%";
progressText.textContent = Math.floor(percent) + "%";
}

function finishReceive() {
const blob = new Blob(receivedBuffers, { type: fileMeta.mime });
progressText.textContent = "Transferencia completa ✔";
downloadBtn.disabled = false;
downloadBtn.onclick = () => {
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = fileMeta.name;
a.click();
URL.revokeObjectURL(url);
};

if (fileMeta.mime.startsWith("image/")) {
imagePreview.src = URL.createObjectURL(blob);
previewContainer.classList.remove("hidden");
}
}
</script>

</body>
</html>
